<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roadmap Gestión de la Innovación - CRPE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* PALETA CORPORATIVA CENS */
            --cens-green: #006633;
            --cens-light-green: #99CC33;
            --cens-cyan: #009FE3;
            --cens-dark-blue: #003854;
            --cens-orange: #BA4818;
            --cens-grey: #666666;
            
            --bg-main: #f4f6f8;
            --text-dark: #333333;
            
            /* Estados Kanban */
            --col-todo: #e0e0e0;
            --col-doing: #d1fae5;
            --col-done: #bbf7d0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-main); margin: 0; padding: 0; color: var(--text-dark);
            display: flex; flex-direction: column; height: 100vh;
        }

        /* --- HEADER --- */
        .admin-header {
            background-color: var(--cens-green); color: white; padding: 0.8rem 2rem;
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-bottom: 4px solid var(--cens-light-green); flex-shrink: 0;
        }
        .header-title h1 { margin: 0; font-size: 1.5rem; font-weight: 700; }
        .header-title h2 { margin: 0; font-size: 0.95rem; font-weight: 400; opacity: 0.95; }
        .vigencia { 
            font-size: 0.75rem; background: rgba(255,255,255,0.2); 
            padding: 2px 8px; border-radius: 10px; margin-left: 10px; vertical-align: middle; 
        }

        .header-actions { display: flex; gap: 8px; }
        
        .btn {
            border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.8rem;
            display: flex; align-items: center; gap: 6px; transition: all 0.2s; text-decoration: none; color: white;
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.1);
        }
        .btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-1px); }
        .btn-primary { background: white; color: var(--cens-green); }
        .btn-primary:hover { background: #f0fdf4; color: #004d26; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .btn-warning { background: var(--cens-orange); } 
        .btn-warning:hover { background: #a33b12; }

        .btn-text { display: inline-block; }
        
        /* Input file oculto */
        #fileInput { display: none; }

        /* --- KANBAN --- */
        .board-container {
            flex-grow: 1; padding: 25px; overflow-x: auto;
            display: flex; gap: 25px; align-items: flex-start;
        }

        .kanban-column {
            flex: 1; min-width: 320px; max-width: 400px;
            background: #ffffff; border-radius: 8px; display: flex; flex-direction: column;
            max-height: 100%; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-top: 5px solid #ccc;
        }
        
        .col-todo { border-top-color: var(--cens-grey); }
        .col-doing { border-top-color: var(--cens-light-green); }
        .col-done { border-top-color: var(--cens-green); }

        .col-header {
            padding: 15px; font-weight: 700; text-transform: uppercase; font-size: 0.9rem;
            display: flex; justify-content: space-between; border-bottom: 1px solid #eee;
        }
        .col-body { padding: 15px; overflow-y: auto; flex-grow: 1; scrollbar-width: thin; background: #fafafa; }

        /* --- TARJETAS --- */
        .kanban-card {
            background: white; border: 1px solid #e5e7eb; border-radius: 6px; border-left: 4px solid transparent;
            padding: 12px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            position: relative; transition: transform 0.2s; cursor: pointer;
        }
        .kanban-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        .card-cat-tag {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 0.65rem; font-weight: 700; color: white; text-transform: uppercase; margin-bottom: 8px;
        }
        .card-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 8px; line-height: 1.4; color: #111827; }
        .card-meta {
            display: flex; justify-content: space-between; align-items: flex-end;
            font-size: 0.75rem; color: #6b7280; border-top: 1px dashed #e5e7eb; padding-top: 8px;
        }
        .card-actions { display: flex; gap: 4px; z-index: 5; }
        .move-btn {
            background: #f3f4f6; border: 1px solid #d1d5db; color: #6b7280;
            width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; font-size: 0.7rem;
        }
        .move-btn:hover { background: var(--cens-green); color: white; border-color: var(--cens-green); }

        /* --- MODALES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 8px; width: 600px; max-width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 1.5rem; align-items: center; }
        .modal-header h2 { margin: 0; color: var(--cens-green); }
        
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
        .form-control {
            width: 100%; padding: 0.6rem; border: 1px solid #ccc; border-radius: 4px;
            font-size: 0.95rem; box-sizing: border-box;
        }
        .btn-submit {
            width: 100%; background: var(--cens-green); color: white; border: none;
            padding: 0.8rem; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 1rem;
        }
        .btn-submit:hover { background: #004d26; }

        .recurrence-panel {
            background: #f0fdf4; padding: 15px; border-radius: 6px; border: 1px solid #bbf7d0; display: none; margin-top: 10px;
        }
        .checkbox-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; max-height: 150px; overflow-y: auto;
        }
        .check-item { font-size: 0.85rem; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        
        .config-list { list-style: none; padding: 0; border: 1px solid #eee; border-radius: 4px; }
        .config-item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .btn-sm { padding: 2px 6px; font-size: 0.7rem; background: #fee2e2; color: #ef4444; border:none; cursor: pointer; }

        /* --- ESTILOS REPORTE --- */
        .report-section { margin-bottom: 30px; }
        .report-title { 
            font-size: 1rem; font-weight: 700; color: var(--cens-dark-blue); 
            border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 15px;
        }
        .report-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .report-item { display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem; }
        .report-bar-bg { flex-grow: 1; height: 8px; background: #eee; border-radius: 4px; margin: 0 15px; }
        .report-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
        .report-value { font-weight: 700; width: 40px; text-align: right; }
        .report-label { width: 120px; font-weight: 600; color: #555; }

    </style>
</head>
<body>

    <header class="admin-header">
        <div class="header-title">
            <h1>Roadmap Gestión de la Innovación</h1>
            <h2>Control y Reducción de Pérdidas de Energía <span class="vigencia">Vigencia 2026</span></h2>
        </div>
        <div class="header-actions">
            <button class="btn" style="background-color: #24292e; color: white;" onclick="openCloudModal()" title="Sincronizar con GitHub">
                <i class="fab fa-github"></i> <span class="btn-text">Nube</span>
            </button>
            <div style="width: 1px; height: 24px; background: rgba(255,255,255,0.3); margin: 0 5px;"></div>

            <input type="file" id="fileInput" accept=".json" onchange="loadFromFile(this)">

            <button class="btn btn-warning" onclick="triggerFileInput()" title="Cargar archivo JSON guardado">
                <i class="fas fa-upload"></i> <span class="btn-text">Cargar Local</span>
            </button>
            <button class="btn btn-primary" onclick="downloadBackup()" title="Guardar cambios en mi PC">
                <i class="fas fa-save"></i> <span class="btn-text">Guardar PC</span>
            </button>

            <button class="btn" onclick="openTaskModal()" title="Crear Tarea">
                <i class="fas fa-plus"></i> 
            </button>
            <button class="btn" onclick="openReportModal()" title="Ver Estadísticas">
                <i class="fas fa-chart-pie"></i> 
            </button>
            <button class="btn" onclick="downloadCSV()" title="Descargar Excel">
                <i class="fas fa-file-excel"></i> 
            </button>
            <button class="btn" onclick="openConfigModal()" title="Configuración">
                <i class="fas fa-cog"></i> 
            </button>
            <button class="btn btn-danger" onclick="safeReset()" title="Borrar Todo">
                <i class="fas fa-trash"></i> 
            </button>
        </div>
    </header>

    <div class="board-container">
        <div class="kanban-column col-todo">
            <div class="col-header"><span><i class="far fa-circle"></i> Por Hacer</span> <span id="count-todo">0</span></div>
            <div class="col-body" id="col-todo"></div>
        </div>
        <div class="kanban-column col-doing">
            <div class="col-header"><span><i class="fas fa-spinner"></i> En Proceso</span> <span id="count-doing">0</span></div>
            <div class="col-body" id="col-doing"></div>
        </div>
        <div class="kanban-column col-done">
            <div class="col-header"><span><i class="fas fa-check-circle"></i> Terminado</span> <span id="count-done">0</span></div>
            <div class="col-body" id="col-done"></div>
        </div>
    </div>

    <div class="modal-overlay" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Tablero de Control</h2>
                <span onclick="closeModal('reportModal')" style="cursor:pointer; font-size:1.5rem">&times;</span>
            </div>
            <div class="report-section">
                <div class="report-title"><i class="fas fa-layer-group"></i> 1. Avance por Categoría</div>
                <div class="report-grid" id="catReportContainer"></div>
            </div>
            <div class="report-section">
                <div class="report-title"><i class="far fa-calendar-check"></i> 2. Cumplimiento por Sprint</div>
                <div class="report-grid" id="sprintReportContainer"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nueva Tarea</h2>
                <span onclick="closeModal('taskModal')" style="cursor:pointer; font-size:1.5rem">&times;</span>
            </div>
            <input type="hidden" id="taskId">
            <div class="form-group"><label>Categoría</label><select id="taskCat" class="form-control"></select></div>
            <div class="form-group"><label>Actividad / Descripción</label><input type="text" id="taskTitle" class="form-control" placeholder="Ej: Reunión de alineación"></div>
            <div class="form-group"><label>Responsable</label><input type="text" id="taskResp" class="form-control" value="Profesional Innovación"></div>
            <div class="form-group" id="simpleSprintGroup"><label>Sprint / Fecha</label><select id="taskSprint" class="form-control"></select></div>
            <div class="form-group" style="margin-top:20px; border-top:1px solid #eee; padding-top:10px">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer"><input type="checkbox" id="checkRecurrence" onchange="toggleRecurrence(this)"> <i class="fas fa-sync-alt"></i> Activar Recurrencia</label>
            </div>
            <div class="recurrence-panel" id="recurrencePanel">
                <div class="form-group"><label>Frecuencia</label><select id="recFrequency" class="form-control"><option value="1">Única</option><option value="2">Quincenal</option><option value="4">Semanal</option></select></div>
                <div class="form-group"><label>Sprints Destino:</label><div class="checkbox-grid" id="sprintCheckboxes"></div></div>
            </div>
            <button class="btn-submit" onclick="saveTask()">Guardar Tarea</button>
        </div>
    </div>

    <div class="modal-overlay" id="cloudModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fab fa-github"></i> Sincronización GitHub</h2>
                <span onclick="closeModal('cloudModal')" style="cursor:pointer; font-size:1.5rem">&times;</span>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #e1e4e8; margin-bottom: 20px;">
                <p style="margin: 0 0 10px 0; font-size: 0.9rem; color: #586069;">Configura tu conexión para guardar el tablero en la nube.</p>
                <div class="form-group">
                    <label>Personal Access Token (Token)</label>
                    <input type="password" id="ghToken" class="form-control" placeholder="ghp_xxxxxxxxxxxx">
                </div>
                <div style="display:flex; gap:10px;">
                    <div class="form-group" style="flex:1">
                        <label>Usuario / Organización</label>
                        <input type="text" id="ghOwner" class="form-control" placeholder="Ej: censnnova-bit">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label>Repositorio</label>
                        <input type="text" id="ghRepo" class="form-control" placeholder="Ej: CRPE">
                    </div>
                </div>
                <div class="form-group">
                    <label>Nombre del Archivo</label>
                    <input type="text" id="ghPath" class="form-control" value="roadmap_data.json">
                </div>
                <button class="btn-primary" style="width:100%; padding: 8px; border:none; border-radius:4px; font-weight:bold; cursor:pointer" onclick="saveCloudConfig()">Guardar Credenciales</button>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <button onclick="githubLoad()" style="padding: 15px; background: #e1f5fe; border: 1px solid #b3e5fc; border-radius: 6px; cursor: pointer; text-align: center; color: #0277bd;">
                    <i class="fas fa-cloud-download-alt" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                    <strong>BAJAR de la Nube</strong><br>
                    <span style="font-size: 0.8rem">Reemplaza lo actual con lo de GitHub</span>
                </button>
                <button onclick="githubSave()" style="padding: 15px; background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 6px; cursor: pointer; text-align: center; color: #2e7d32;">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                    <strong>SUBIR a la Nube</strong><br>
                    <span style="font-size: 0.8rem">Guarda lo actual en GitHub</span>
                </button>
            </div>
            <div id="cloudStatus" style="margin-top: 15px; font-size: 0.9rem; text-align: center; font-weight: bold;"></div>
        </div>
    </div>

    <script>
        // === CONFIGURACIÓN Y DATOS ===
        const STORAGE_KEY = 'cens_roadmap_local_v10'; // Solo para cache local temporal
        
        const catColors = {
            'Alineación': 'var(--cens-green)',
            'Gestión Ágil': 'var(--cens-light-green)',
            'Herramientas': 'var(--cens-cyan)',
            'Estudios': 'var(--cens-dark-blue)',
            'Vigilancia': 'var(--cens-orange)',
            'Comunicación': 'var(--cens-grey)',
            'General': '#999'
        };

        const defaultSprints = ['Sprint 1 (Ene)', 'Sprint 2 (Feb)', 'Sprint 3 (Mar)', 'Sprint 4 (Abr)', 'Sprint 5 (May)', 'Sprint 6 (Jun)', 'Q1-Q4 (Anual)'];
        const defaultCats = Object.keys(catColors).filter(k => k !== 'General');

        let data = { tasks: [], sprints: [...defaultSprints], cats: [...defaultCats] };

        // === CLOUD / GITHUB INTEGRATION ===
        const GH_CONFIG_KEY = 'cens_roadmap_gh_config';
        let ghConfig = { token: '', owner: '', repo: '', path: 'roadmap_data.json' };

        function loadCloudConfig() {
            const stored = localStorage.getItem(GH_CONFIG_KEY);
            if (stored) {
                ghConfig = JSON.parse(stored);
                document.getElementById('ghToken').value = ghConfig.token;
                document.getElementById('ghOwner').value = ghConfig.owner;
                document.getElementById('ghRepo').value = ghConfig.repo;
                document.getElementById('ghPath').value = ghConfig.path || 'roadmap_data.json';
            }
        }

        function saveCloudConfig() {
            ghConfig.token = document.getElementById('ghToken').value.trim();
            ghConfig.owner = document.getElementById('ghOwner').value.trim();
            ghConfig.repo = document.getElementById('ghRepo').value.trim();
            ghConfig.path = document.getElementById('ghPath').value.trim();
            
            if(!ghConfig.token || !ghConfig.owner || !ghConfig.repo) {
                alert("Por favor completa todos los campos (Token, Usuario, Repo)");
                return;
            }

            localStorage.setItem(GH_CONFIG_KEY, JSON.stringify(ghConfig));
            alert("Credenciales guardadas en este navegador.");
        }

        function openCloudModal() {
            loadCloudConfig();
            document.getElementById('cloudModal').style.display = 'flex';
            document.getElementById('cloudStatus').innerText = '';
        }

        // Utilidad para Base64 con soporte Unicode
        function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
        function b64_to_utf8(str) { return decodeURIComponent(escape(window.atob(str))); }

        async function githubLoad() {
            const status = document.getElementById('cloudStatus');
            if(!ghConfig.token) return alert("Configura primero las credenciales.");
            
            status.innerText = "Conectando con GitHub...";
            status.style.color = "blue";

            try {
                const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/${ghConfig.path}`;
                const response = await fetch(url, {
                    headers: { 'Authorization': `token ${ghConfig.token}`, 'Accept': 'application/vnd.github.v3+json' }
                });

                if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);

                const json = await response.json();
                const content = b64_to_utf8(json.content);
                
                data = JSON.parse(content);
                saveToLocalStorage();
                renderBoard();
                
                status.innerText = "✅ ¡Datos descargados exitosamente!";
                status.style.color = "green";
                setTimeout(() => closeModal('cloudModal'), 1500);

            } catch (error) {
                console.error(error);
                status.innerText = "❌ Error: " + error.message;
                status.style.color = "red";
            }
        }

        async function githubSave() {
            const status = document.getElementById('cloudStatus');
            if(!ghConfig.token) return alert("Configura primero las credenciales.");

            status.innerText = "Preparando subida...";
            status.style.color = "blue";

            try {
                const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/${ghConfig.path}`;
                
                // 1. Obtener SHA actual (si existe)
                let sha = null;
                try {
                    const checkResp = await fetch(url, {
                        headers: { 'Authorization': `token ${ghConfig.token}` }
                    });
                    if (checkResp.ok) {
                        const fileData = await checkResp.json();
                        sha = fileData.sha;
                    }
                } catch (e) { console.log("Archivo nuevo o error de red", e); }

                // 2. Subir nuevo contenido
                const contentBase64 = utf8_to_b64(JSON.stringify(data, null, 2));
                const body = {
                    message: `Actualización roadmap ${new Date().toLocaleString()}`,
                    content: contentBase64
                };
                if (sha) body.sha = sha;

                const putResp = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${ghConfig.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (!putResp.ok) throw new Error(`Error subiendo: ${putResp.statusText}`);

                status.innerText = "✅ ¡Guardado en GitHub correctamente!";
                status.style.color = "green";
                
            } catch (error) {
                console.error(error);
                status.innerText = "❌ Error al guardar: " + error.message;
                status.style.color = "red";
            }
        }

        // === INICIALIZACIÓN ===
        document.addEventListener('DOMContentLoaded', async () => {
            // Cargar configuración de credenciales (si existen en este PC)
            loadCloudConfig();

            // ESTRATEGIA DE CARGA AUTOMÁTICA (Magic Link):
            // 1. Intentamos leer 'roadmap_data.json' directamente del sitio (Público, lectura rápida)
            // 2. Si falla (archivo no existe o error), leemos de LocalStorage (Caché local)
            
            const loadedFromServer = await loadPublicData();

            if (!loadedFromServer) {
                loadFromLocalStorage(); // Fallback a local
                console.log("Modo: Local (No se encontró archivo en nube)");
            } else {
                console.log("Modo: Nube (Datos sincronizados)");
                // Opcional: Mostrar un pequeño indicador visual
                const title = document.querySelector('.header-title h2');
                if(title) title.innerHTML += ' <span style="font-size:0.7rem; background:#dcfce7; color:#166534; padding:2px 6px; border-radius:4px; margin-left:8px">☁️ Sincronizado</span>';
            }

            renderBoard();
        });

        // Función para leer datos PÚBLICOS (Sin Token)
        // Esto permite que cualquiera con el link vea el tablero actualizado
        async function loadPublicData() {
            try {
                // Usamos fetch relativo. Funciona perfecto en GitHub Pages.
                // Agregamos timestamp para evitar caché agresivo del navegador
                const response = await fetch('./roadmap_data.json?t=' + new Date().getTime());
                
                if (response.ok) {
                    const jsonData = await response.json();
                    if (Array.isArray(jsonData.tasks)) {
                        data = jsonData;
                        return true;
                    }
                }
            } catch (e) {
                // Es normal que falle si es la primera vez y no has subido el archivo aún
                console.warn("No se encontraron datos públicos aún.", e);
            }
            return false;
        }

        // === GESTIÓN DE ARCHIVOS (LA SOLUCIÓN TI-FRIENDLY) ===
        
        // 1. Botón Guardar (Exportar JSON)
        function downloadBackup() {
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Crear nombre con fecha para versionamiento
            const date = new Date().toISOString().slice(0,10);
            const link = document.createElement("a");
            link.href = url;
            link.download = `tablero_innovacion_${date}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert("✅ Archivo guardado.\n\nGuárdalo en tu OneDrive/SharePoint para asegurar la información.");
        }

        // 2. Botón Cargar (Importar JSON)
        function triggerFileInput() {
            document.getElementById('fileInput').click();
        }

        function loadFromFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    // Validar estructura básica
                    if (Array.isArray(jsonData.tasks) && Array.isArray(jsonData.sprints)) {
                        data = jsonData;
                        saveToLocalStorage(); // Guardar en cache local también
                        renderBoard();
                        alert("✅ Tablero cargado exitosamente.");
                    } else {
                        alert("❌ El archivo no tiene el formato correcto.");
                    }
                } catch (err) {
                    alert("❌ Error al leer el archivo JSON.");
                    console.error(err);
                }
            };
            reader.readAsText(file);
            // Limpiar input para permitir cargar el mismo archivo si se modifica
            input.value = ''; 
        }

        // === PERSISTENCIA LOCAL (Cache) ===
        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    data = JSON.parse(stored);
                } else {
                    initDefaultTasks();
                    saveToLocalStorage();
                }
            } catch (e) { initDefaultTasks(); }
        }

        function saveToLocalStorage() {
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch (e) {}
        }

        function initDefaultTasks() {
            data.tasks = [
                { id: 1, status: 'todo', cat: 'Comunicación', title: 'Ejemplo: Cargar archivo de OneDrive', resp: 'Tú', sprint: 'Sprint 1 (Ene)' }
            ];
        }

        // === RENDERIZADO TABLERO (IGUAL QUE ANTES) ===
        function renderBoard() {
            ['todo', 'doing', 'done'].forEach(s => {
                const col = document.getElementById(`col-${s}`);
                if(col) col.innerHTML = '';
                const count = document.getElementById(`count-${s}`);
                if(count) count.innerText = 0;
            });

            const counts = { todo: 0, doing: 0, done: 0 };
            
            if(Array.isArray(data.tasks)) {
                data.tasks.forEach(task => {
                    if(!counts.hasOwnProperty(task.status)) task.status = 'todo';
                    counts[task.status]++;
                    const card = createCardHTML(task);
                    document.getElementById(`col-${task.status}`).insertAdjacentHTML('beforeend', card);
                });
            }

            Object.keys(counts).forEach(k => {
                const el = document.getElementById(`count-${k}`);
                if(el) el.innerText = counts[k];
            });
        }

        function createCardHTML(task) {
            const color = catColors[task.cat] || '#999';
            const prevBtn = task.status !== 'todo' ? 
                `<button class="move-btn" onclick="moveTask('${task.id}', -1); event.stopPropagation();"><i class="fas fa-arrow-left"></i></button>` : '';
            const nextBtn = task.status !== 'done' ? 
                `<button class="move-btn" onclick="moveTask('${task.id}', 1); event.stopPropagation();"><i class="fas fa-arrow-right"></i></button>` : '';

            return `
            <div class="kanban-card" onclick="openTaskModal('${task.id}')" style="border-left-color: ${color}">
                <span class="card-cat-tag" style="background-color: ${color}">${task.cat}</span>
                <div class="card-title">${task.title}</div>
                <div class="card-meta">
                    <div><i class="far fa-user"></i> ${task.resp}</div>
                    <div><i class="far fa-calendar"></i> ${task.sprint}</div>
                </div>
                <div class="card-actions" style="margin-top:8px; justify-content:flex-end">
                    ${prevBtn} ${nextBtn}
                </div>
            </div>`;
        }

        // === FUNCIONES LÓGICAS (IGUAL QUE ANTES) ===
        function saveTask() {
            const id = document.getElementById('taskId').value;
            const title = document.getElementById('taskTitle').value;
            const cat = document.getElementById('taskCat').value;
            const resp = document.getElementById('taskResp').value;
            const isRecurrent = document.getElementById('checkRecurrence').checked;

            if(!title) return alert("Escribe el nombre de la actividad.");

            if(id) {
                const task = data.tasks.find(t => String(t.id) === String(id));
                if(task) { task.title = title; task.cat = cat; task.resp = resp; task.sprint = document.getElementById('taskSprint').value; }
            } else {
                if (isRecurrent) {
                    const freq = parseInt(document.getElementById('recFrequency').value);
                    const checks = document.querySelectorAll('.rec-sprint-check:checked');
                    if(checks.length === 0) return alert("Selecciona sprints.");
                    checks.forEach(chk => {
                        for(let i=1; i<=freq; i++) {
                            data.tasks.push({ id: Date.now()+Math.random(), status: 'todo', cat, resp, sprint: chk.value, title: title + (freq>1?` (${i})`:'') });
                        }
                    });
                } else {
                    data.tasks.push({ id: Date.now(), status: 'todo', cat, resp, title, sprint: document.getElementById('taskSprint').value });
                }
            }
            saveToLocalStorage(); // Autoguardado local
            renderBoard();
            closeModal('taskModal');
        }

        function moveTask(id, dir) {
            const task = data.tasks.find(t => String(t.id) === String(id));
            if(task) {
                const flow = ['todo', 'doing', 'done'];
                const idx = flow.indexOf(task.status);
                const nextIdx = idx + dir;
                if(nextIdx >= 0 && nextIdx < flow.length) {
                    task.status = flow[nextIdx];
                    saveToLocalStorage(); // Autoguardado local
                    renderBoard();
                }
            }
        }

        // === REPORTES, MODALES Y UTILS (MISMOS QUE VERSIÓN ANTERIOR) ===
        function openReportModal() {
            const catContainer = document.getElementById('catReportContainer');
            const sprintContainer = document.getElementById('sprintReportContainer');
            catContainer.innerHTML = ''; sprintContainer.innerHTML = '';

            const catStats = {}; data.cats.forEach(c => catStats[c] = { total: 0, done: 0 });
            const sprintStats = {}; data.sprints.forEach(s => sprintStats[s] = { total: 0, done: 0 });

            data.tasks.forEach(t => {
                if(!catStats[t.cat]) catStats[t.cat] = { total: 0, done: 0 };
                catStats[t.cat].total++;
                if(t.status === 'done') catStats[t.cat].done++;

                if(!sprintStats[t.sprint]) sprintStats[t.sprint] = { total: 0, done: 0 };
                sprintStats[t.sprint].total++;
                if(t.status === 'done') sprintStats[t.sprint].done++;
            });

            const drawBar = (container, label, stats, color) => {
                if(stats.total === 0) return;
                const pct = Math.round((stats.done / stats.total) * 100);
                container.innerHTML += `
                    <div class="report-item"><span class="report-label" style="color:${color}">${label}</span>
                    <div class="report-bar-bg"><div class="report-bar-fill" style="width:${pct}%; background:${color}"></div></div>
                    <span class="report-value">${pct}%</span></div>`;
            };

            Object.keys(catStats).forEach(c => drawBar(catContainer, c, catStats[c], catColors[c]||'#999'));
            Object.keys(sprintStats).forEach(s => drawBar(sprintContainer, s, sprintStats[s], sprintStats[s].total > 0 && sprintStats[s].done === sprintStats[s].total ? 'var(--cens-green)' : 'var(--cens-dark-blue)'));

            document.getElementById('reportModal').style.display = 'flex';
        }

        function openTaskModal(taskId=null) {
            const sList = document.getElementById('taskSprint'); const cList = document.getElementById('taskCat'); const chkList = document.getElementById('sprintCheckboxes');
            sList.innerHTML = data.sprints.map(s=>`<option value="${s}">${s}</option>`).join('');
            cList.innerHTML = data.cats.map(c=>`<option value="${c}">${c}</option>`).join('');
            chkList.innerHTML = data.sprints.map(s=>`<label class="check-item"><input type="checkbox" value="${s}" class="rec-sprint-check"> ${s}</label>`).join('');
            
            document.getElementById('taskId').value = ''; document.getElementById('taskTitle').value = ''; document.getElementById('checkRecurrence').checked = false; toggleRecurrence(document.getElementById('checkRecurrence'));

            if(taskId && taskId !== 'undefined') {
                const t = data.tasks.find(x => String(x.id) === String(taskId));
                if(t) {
                    document.getElementById('modalTitle').innerText = 'Editar Tarea';
                    document.getElementById('taskId').value = t.id; document.getElementById('taskCat').value = t.cat; document.getElementById('taskTitle').value = t.title; document.getElementById('taskResp').value = t.resp; document.getElementById('taskSprint').value = t.sprint;
                    document.getElementById('checkRecurrence').parentElement.style.display = 'none';
                }
            } else { document.getElementById('modalTitle').innerText = 'Nueva Tarea'; document.getElementById('checkRecurrence').parentElement.style.display = 'flex'; }
            document.getElementById('taskModal').style.display = 'flex';
        }

        function toggleRecurrence(chk) { document.getElementById('recurrencePanel').style.display = chk.checked ? 'block' : 'none'; document.getElementById('simpleSprintGroup').style.display = chk.checked ? 'none' : 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        window.onclick = function(e) { if(e.target.classList.contains('modal-overlay')) e.target.style.display='none'; }
        
        function openConfigModal() { updateConfigUI(); document.getElementById('configModal').style.display = 'flex'; }
        function updateConfigUI() {
            const build = (arr, id, type) => document.getElementById(id).innerHTML = arr.map((x,i)=>`<li class="config-item">${x} <button class="btn-sm" onclick="rmCfg('${type}',${i})">X</button></li>`).join('');
            build(data.sprints, 'configSprintsList', 'sprints'); build(data.cats, 'configCatsList', 'cats');
        }
        function addConfigItem(type) { const el = document.getElementById(type==='sprints'?'newSprintInput':'newCatInput'); if(el.value){ data[type].push(el.value); el.value=''; updateConfigUI(); saveToLocalStorage(); } }
        function rmCfg(type, idx) { if(confirm('¿Eliminar?')){ data[type].splice(idx,1); updateConfigUI(); saveToLocalStorage(); } }
        
        function safeReset() { if(confirm('¿Borrar todo?')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } }
        
        function downloadCSV() {
            let csv = "\uFEFFID;Estado;Categoría;Tarea;Responsable;Sprint\n";
            data.tasks.forEach(t => csv += `${t.id};${t.status};${t.cat};"${t.title.replace(/(\r\n|\n|\r)/gm," ")}";${t.resp};${t.sprint}\n`);
            const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8;'})); a.download = "reporte.csv"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
    </script>
</body>
</html>